name: 'Tag and Release'
description: 'Tags and releases a new version of the project'
inputs:
  release:
    description: 'Release Branch: [latest, release-x.y.z, x.y.z]'
    required: false
    default: 'latest'
  token:
    description: 'GitHub Token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Determine Latest Release Branch
      id: get_latest_release_branch
      shell: bash
      run: |
        release_input="${{ inputs.release }}"

        if [[ ! $release_input =~ ^(latest|release-[0-9]+\.[0-9]+\.[0-9]+|v?[0-9]+\.[0-9]+\.[0-9]+|[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "Invalid release input. Please provide 'latest' or a version in the format 'release-x.y.z', 'v0.1.0', or '0.1.0'."
          exit 1
        fi

        if [[ $release_input == 'latest' ]]; then
          git fetch --all
          LATEST_RELEASE_BRANCH=$(git branch -r --list 'origin/release-*' | sed 's|origin/||' | sort -V | tail -1)
          LATEST_RELEASE_BRANCH=$(echo "$LATEST_RELEASE_BRANCH" | xargs)
          if [[ -z $LATEST_RELEASE_BRANCH ]]; then
            release="main"
          else
            release=$LATEST_RELEASE_BRANCH
          fi
        else
          if [[ $release_input =~ ^release-[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            release=$release_input
          elif [[ $release_input =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            release="release-${release_input#v}"
          else
            echo "Unexpected release format. Exiting."
            exit 1
          fi
        fi

        release=$(echo "$release" | xargs)

        if [[ $release =~ ^release-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          version="${BASH_REMATCH[1]}"
        elif [[ $release =~ ^v?([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          version="${BASH_REMATCH[1]}"
        else
          echo "Unexpected release format. Exiting."
          exit 1
        fi

        echo "Latest Release Branch: $release"
        echo "Version: $version"
          
        echo "LATEST_RELEASE_BRANCH=$release" >> $GITHUB_ENV
        echo "VERSION=$version" >> $GITHUB_ENV

    - name: Set Repository Environment Variables
      run: |
        echo "REPO_OWNER=tvangundy" >> $GITHUB_ENV
        echo "REPO_NAME=rp-cli" >> $GITHUB_ENV
        
        # echo "REPO_OWNER=windsorcli" >> $GITHUB_ENV
        # echo "REPO_NAME=cli" >> $GITHUB_ENV

    - name: Checkout Release Branch
      uses: actions/checkout@v2
      with:
        repository: ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
        ref: ${{ env.LATEST_RELEASE_BRANCH }}
        token: ${{ inputs.token }}

    - name: Create Tag
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.token }}
        script: |
          const version = process.env.VERSION;
          const tagName = `v${version}`;
          const { data: ref } = await github.rest.git.createRef({
            owner: process.env.REPO_OWNER,
            repo: process.env.REPO_NAME,
            ref: `refs/tags/${tagName}`,
            sha: context.sha
          });
          console.log(`Created tag: ${ref.ref}`);

    - name: Create Release
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.token }}
        script: |
          const version = process.env.VERSION;
          const tagName = `v${version}`;
          const { data: release } = await github.rest.repos.createRelease({
            owner: process.env.REPO_OWNER,
            repo: process.env.REPO_NAME,
            tag_name: tagName,
            name: tagName,
            body: `Release ${tagName}`,
            draft: false,
            prerelease: false
          });
          console.log(`Created release: ${release.name}`);

    # - name: Checkout Release Branch
    #   uses: actions/checkout@v2
    #   with:
    #     ref: ${{ env.LATEST_RELEASE_BRANCH }}

    # - name: Create Tag
    #   uses: actions/github-script@v7
    #   with:
    #     github-token: ${{ inputs.token }}
    #     script: |
    #       const version = process.env.version;
    #       const tagName = `v${version}`;
    #       const { data: ref } = await github.rest.git.createRef({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         ref: `refs/tags/${tagName}`,
    #         sha: context.sha
    #       });
    #       console.log(`Created tag: ${ref.ref}`);

    # - name: Create Release
    #   uses: actions/github-script@v7
    #   with:
    #     github-token: ${{ inputs.token }}
    #     script: |
    #       const version = process.env.version;
    #       const tagName = `v${version}`;
    #       const { data: release } = await github.rest.repos.createRelease({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         tag_name: tagName,
    #         name: tagName,
    #         body: `Release ${tagName}`,
    #         draft: false,
    #         prerelease: false
    #       });
    #       console.log(`Created release: ${release.name}`);
